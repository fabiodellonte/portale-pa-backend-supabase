name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Backend structural tests
        shell: pwsh
        run: ./tests/backend-ci-test.ps1

      - name: Email report
        if: always() && secrets.SMTP_SERVER != ''
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          CI_STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          RUN_ID: ${{ github.run_id }}
        run: |
          python - <<'PY'
          import os, smtplib
          from email.message import EmailMessage

          msg = EmailMessage()
          msg['Subject'] = f"[{os.environ['REPO']}] CI {os.environ['CI_STATUS']}"
          msg['From'] = os.environ['SMTP_FROM']
          msg['To'] = 'fabiodellonte@gmail.com'
          msg.set_content(
              f"Repository: {os.environ['REPO']}\n"
              f"Branch: {os.environ['BRANCH']}\n"
              f"Status: {os.environ['CI_STATUS']}\n"
              f"Run: https://github.com/{os.environ['REPO']}/actions/runs/{os.environ['RUN_ID']}\n"
          )

          with smtplib.SMTP_SSL(os.environ['SMTP_SERVER'], int(os.environ['SMTP_PORT'])) as s:
              s.login(os.environ['SMTP_USERNAME'], os.environ['SMTP_PASSWORD'])
              s.send_message(msg)
          PY
